name: Trading Cron Jobs

on:
  schedule:
    # 20ç§’æŒ‡æ ‡æ”¶é›† - æ¯1åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    - cron: '*/1 * * * *'
    # 3åˆ†é’Ÿäº¤æ˜“æ‰§è¡Œ - æ¯3åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡  
    - cron: '*/3 * * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘ç”¨äºæµ‹è¯•
  workflow_dispatch:

jobs:
  metrics-interval:
    name: 20ç§’æŒ‡æ ‡æ”¶é›†
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '*/1 * * * *'
    
    steps:
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: éªŒè¯ç¯å¢ƒå˜é‡
        env:
          NEXT_PUBLIC_URL: ${{ secrets.NEXT_PUBLIC_URL }}
        run: |
          echo "æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
          if [ -z "${{ secrets.CRON_SECRET_KEY }}" ]; then
            echo "âŒ CRON_SECRET_KEY æœªè®¾ç½®"
            exit 1
          fi
          if [ -z "${{ secrets.NEXT_PUBLIC_URL }}" ]; then
            echo "âŒ NEXT_PUBLIC_URL æœªè®¾ç½®"
            exit 1
          fi
          
          echo "âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡"
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
          echo "NEXT_PUBLIC_URL é•¿åº¦: ${#NEXT_PUBLIC_URL}"
          echo "NEXT_PUBLIC_URL å†…å®¹: '${NEXT_PUBLIC_URL}'"
          
          # éªŒè¯ URL æ ¼å¼
          if [[ ! "$NEXT_PUBLIC_URL" =~ ^https?:// ]]; then
            echo "âŒ NEXT_PUBLIC_URL æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´"
            exit 1
          fi
          
          echo "âœ… URL æ ¼å¼éªŒè¯é€šè¿‡"
          
      - name: ç”ŸæˆJWT Tokenå¹¶æ‰§è¡ŒæŒ‡æ ‡æ”¶é›†
        env:
          CRON_SECRET_KEY: ${{ secrets.CRON_SECRET_KEY }}
          NEXT_PUBLIC_URL: ${{ secrets.NEXT_PUBLIC_URL }}
        run: |
          # å®‰è£… jsonwebtoken
          npm install jsonwebtoken
          
          # è°ƒè¯•å¯†é’¥ä¿¡æ¯
          echo "ğŸ” å¯†é’¥è°ƒè¯•ä¿¡æ¯:"
          echo "CRON_SECRET_KEY é•¿åº¦: ${#CRON_SECRET_KEY}"
          echo "CRON_SECRET_KEY å‰10å­—ç¬¦: ${CRON_SECRET_KEY:0:10}..."
          
          # ç”ŸæˆJWT token
          JWT_TOKEN=$(node -e "
            const jwt = require('jsonwebtoken');
            const secretKey = process.env.CRON_SECRET_KEY;
            if (!secretKey) {
              console.error('CRON_SECRET_KEY is empty');
              process.exit(1);
            }
            
            console.log('å¯†é’¥é•¿åº¦:', secretKey.length);
            console.log('å¯†é’¥ç±»å‹:', typeof secretKey);
            console.log('å¯†é’¥å‰10å­—ç¬¦:', secretKey.substring(0, 10) + '...');
            
            const token = jwt.sign(
              { sub: 'github-actions-cron', iat: Math.floor(Date.now() / 1000) },
              secretKey,
              { expiresIn: '1h' }
            );
            
            // éªŒè¯ç”Ÿæˆçš„token
            try {
              const decoded = jwt.verify(token, secretKey);
              console.log('TokenéªŒè¯æˆåŠŸ:', decoded);
            } catch (err) {
              console.error('TokenéªŒè¯å¤±è´¥:', err.message);
            }
            
            console.log(token);
          ")
          
          echo "ç”Ÿæˆçš„JWT Token: ${JWT_TOKEN:0:20}..."
          echo "JWT Token é•¿åº¦: ${#JWT_TOKEN}"
          
          # å°† JWT token ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œé¿å… shell å˜é‡ä¼ é€’é—®é¢˜
          echo "${JWT_TOKEN}" > /tmp/jwt_token.txt
          echo "âœ… JWT token å·²ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶"
          
          # è°ƒç”¨API
          echo "è°ƒç”¨API: ${NEXT_PUBLIC_URL}/api/cron/20-seconds-metrics-interval"
          
          # å¯¹ JWT token è¿›è¡Œ URL ç¼–ç  - ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼
          ENCODED_TOKEN=$(node -e "
            const fs = require('fs');
            const token = fs.readFileSync('/tmp/jwt_token.txt', 'utf8').trim();
            console.log(encodeURIComponent(token));
          ")
          
          # æ„å»ºå®Œæ•´çš„ URL
          FULL_URL="${NEXT_PUBLIC_URL}/api/cron/20-seconds-metrics-interval?token=${ENCODED_TOKEN}"
          echo "å®Œæ•´URLé•¿åº¦: ${#FULL_URL}"
          echo "URLç¼–ç åçš„Tokené•¿åº¦: ${#ENCODED_TOKEN}"
          
          # ä½¿ç”¨æ›´å®‰å…¨çš„ curl è°ƒç”¨
          curl -X GET \
            --url "${FULL_URL}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions/1.0" \
            --fail-with-body \
            -w "\nHTTP Status: %{http_code}\nResponse Time: %{time_total}s\n" \
            -v

  run-interval:
    name: 3åˆ†é’Ÿäº¤æ˜“æ‰§è¡Œ
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '*/3 * * * *'
    
    steps:
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: éªŒè¯ç¯å¢ƒå˜é‡
        env:
          NEXT_PUBLIC_URL: ${{ secrets.NEXT_PUBLIC_URL }}
        run: |
          echo "æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
          if [ -z "${{ secrets.CRON_SECRET_KEY }}" ]; then
            echo "âŒ CRON_SECRET_KEY æœªè®¾ç½®"
            exit 1
          fi
          if [ -z "${{ secrets.NEXT_PUBLIC_URL }}" ]; then
            echo "âŒ NEXT_PUBLIC_URL æœªè®¾ç½®"
            exit 1
          fi
          
          echo "âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡"
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
          echo "NEXT_PUBLIC_URL é•¿åº¦: ${#NEXT_PUBLIC_URL}"
          echo "NEXT_PUBLIC_URL å†…å®¹: '${NEXT_PUBLIC_URL}'"
          
          # éªŒè¯ URL æ ¼å¼
          if [[ ! "$NEXT_PUBLIC_URL" =~ ^https?:// ]]; then
            echo "âŒ NEXT_PUBLIC_URL æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´"
            exit 1
          fi
          
          echo "âœ… URL æ ¼å¼éªŒè¯é€šè¿‡"
          
      - name: ç”ŸæˆJWT Tokenå¹¶æ‰§è¡Œäº¤æ˜“é€»è¾‘
        env:
          CRON_SECRET_KEY: ${{ secrets.CRON_SECRET_KEY }}
          NEXT_PUBLIC_URL: ${{ secrets.NEXT_PUBLIC_URL }}
        run: |
          # å®‰è£… jsonwebtoken
          npm install jsonwebtoken
          
          # è°ƒè¯•å¯†é’¥ä¿¡æ¯
          echo "ğŸ” å¯†é’¥è°ƒè¯•ä¿¡æ¯:"
          echo "CRON_SECRET_KEY é•¿åº¦: ${#CRON_SECRET_KEY}"
          echo "CRON_SECRET_KEY å‰10å­—ç¬¦: ${CRON_SECRET_KEY:0:10}..."
          
          # ç”ŸæˆJWT token
          JWT_TOKEN=$(node -e "
            const jwt = require('jsonwebtoken');
            const secretKey = process.env.CRON_SECRET_KEY;
            if (!secretKey) {
              console.error('CRON_SECRET_KEY is empty');
              process.exit(1);
            }
            
            console.log('å¯†é’¥é•¿åº¦:', secretKey.length);
            console.log('å¯†é’¥ç±»å‹:', typeof secretKey);
            console.log('å¯†é’¥å‰10å­—ç¬¦:', secretKey.substring(0, 10) + '...');
            
            const token = jwt.sign(
              { sub: 'github-actions-cron', iat: Math.floor(Date.now() / 1000) },
              secretKey,
              { expiresIn: '1h' }
            );
            
            // éªŒè¯ç”Ÿæˆçš„token
            try {
              const decoded = jwt.verify(token, secretKey);
              console.log('TokenéªŒè¯æˆåŠŸ:', decoded);
            } catch (err) {
              console.error('TokenéªŒè¯å¤±è´¥:', err.message);
            }
            
            console.log(token);
          ")
          
          echo "ç”Ÿæˆçš„JWT Token: ${JWT_TOKEN:0:20}..."
          echo "JWT Token é•¿åº¦: ${#JWT_TOKEN}"
          
          # å°† JWT token ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œé¿å… shell å˜é‡ä¼ é€’é—®é¢˜
          echo "${JWT_TOKEN}" > /tmp/jwt_token.txt
          echo "âœ… JWT token å·²ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶"
          
          # è°ƒç”¨API
          echo "è°ƒç”¨API: ${NEXT_PUBLIC_URL}/api/cron/3-minutes-run-interval"
          
          # å¯¹ JWT token è¿›è¡Œ URL ç¼–ç  - ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼
          ENCODED_TOKEN=$(node -e "
            const fs = require('fs');
            const token = fs.readFileSync('/tmp/jwt_token.txt', 'utf8').trim();
            console.log(encodeURIComponent(token));
          ")
          
          # æ„å»ºå®Œæ•´çš„ URL
          FULL_URL="${NEXT_PUBLIC_URL}/api/cron/3-minutes-run-interval?token=${ENCODED_TOKEN}"
          echo "å®Œæ•´URLé•¿åº¦: ${#FULL_URL}"
          echo "URLç¼–ç åçš„Tokené•¿åº¦: ${#ENCODED_TOKEN}"
          
          # ä½¿ç”¨æ›´å®‰å…¨çš„ curl è°ƒç”¨
          curl -X GET \
            --url "${FULL_URL}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions/1.0" \
            --fail-with-body \
            -w "\nHTTP Status: %{http_code}\nResponse Time: %{time_total}s\n" \
            -v