name: Trading Cron Jobs

on:
  schedule:
    # 20秒指标收集 - 每1分钟执行一次
    - cron: '*/1 * * * *'
    # 3分钟交易执行 - 每3分钟执行一次  
    - cron: '*/3 * * * *'
  # 允许手动触发用于测试
  workflow_dispatch:

jobs:
  metrics-interval:
    name: 20秒指标收集
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '*/1 * * * *'
    
    steps:
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: 生成JWT Token并执行指标收集
        run: |
          # 安装 jsonwebtoken
          npm install jsonwebtoken
          
          # 生成JWT token
          JWT_TOKEN=$(node -e "
            const jwt = require('jsonwebtoken');
            const token = jwt.sign(
              { sub: 'github-actions-cron' },
              '${{ secrets.CRON_SECRET_KEY }}',
              { expiresIn: '1h' }
            );
            console.log(token);
          ")
          
          # 调用API
          curl -X GET \
            "${{ secrets.NEXT_PUBLIC_URL }}/api/cron/20-seconds-metrics-interval?token=${JWT_TOKEN}" \
            -H "Content-Type: application/json"

  run-interval:
    name: 3分钟交易执行
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '*/3 * * * *'
    
    steps:
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: 生成JWT Token并执行交易逻辑
        run: |
          # 安装 jsonwebtoken
          npm install jsonwebtoken
          
          # 生成JWT token
          JWT_TOKEN=$(node -e "
            const jwt = require('jsonwebtoken');
            const token = jwt.sign(
              { sub: 'github-actions-cron' },
              '${{ secrets.CRON_SECRET_KEY }}',
              { expiresIn: '1h' }
            );
            console.log(token);
          ")
          
          # 调用API
          curl -X GET \
            "${{ secrets.NEXT_PUBLIC_URL }}/api/cron/3-minutes-run-interval?token=${JWT_TOKEN}" \
            -H "Content-Type: application/json"