name: Trading Cron Jobs

on:
  schedule:
    # 20秒指标收集 - 每1分钟执行一次
    - cron: '*/1 * * * *'
    # 3分钟交易执行 - 每3分钟执行一次  
    - cron: '*/3 * * * *'
  # 允许手动触发用于测试
  workflow_dispatch:

jobs:
  metrics-interval:
    name: 20秒指标收集
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '*/1 * * * *'
    
    steps:
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: 验证环境变量
        env:
          NEXT_PUBLIC_URL: ${{ secrets.NEXT_PUBLIC_URL }}
        run: |
          echo "检查必需的环境变量..."
          if [ -z "${{ secrets.CRON_SECRET_KEY }}" ]; then
            echo "❌ CRON_SECRET_KEY 未设置"
            exit 1
          fi
          if [ -z "${{ secrets.NEXT_PUBLIC_URL }}" ]; then
            echo "❌ NEXT_PUBLIC_URL 未设置"
            exit 1
          fi
          
          echo "✅ 环境变量检查通过"
          echo "🔍 调试信息:"
          echo "NEXT_PUBLIC_URL 长度: ${#NEXT_PUBLIC_URL}"
          echo "NEXT_PUBLIC_URL 内容: '${NEXT_PUBLIC_URL}'"
          
          # 验证 URL 格式
          if [[ ! "$NEXT_PUBLIC_URL" =~ ^https?:// ]]; then
            echo "❌ NEXT_PUBLIC_URL 格式错误，必须以 http:// 或 https:// 开头"
            exit 1
          fi
          
          echo "✅ URL 格式验证通过"
          
      - name: 生成JWT Token并执行指标收集
        env:
          CRON_SECRET_KEY: ${{ secrets.CRON_SECRET_KEY }}
          NEXT_PUBLIC_URL: ${{ secrets.NEXT_PUBLIC_URL }}
        run: |
          # 安装 jsonwebtoken
          npm install jsonwebtoken
          
          # 调试密钥信息
          echo "🔐 密钥调试信息:"
          echo "CRON_SECRET_KEY 长度: ${#CRON_SECRET_KEY}"
          echo "CRON_SECRET_KEY 前10字符: ${CRON_SECRET_KEY:0:10}..."
          
          # 生成JWT token
          JWT_TOKEN=$(node -e "
            const jwt = require('jsonwebtoken');
            const secretKey = process.env.CRON_SECRET_KEY;
            if (!secretKey) {
              console.error('CRON_SECRET_KEY is empty');
              process.exit(1);
            }
            
            console.log('密钥长度:', secretKey.length);
            console.log('密钥类型:', typeof secretKey);
            console.log('密钥前10字符:', secretKey.substring(0, 10) + '...');
            
            const token = jwt.sign(
              { sub: 'github-actions-cron', iat: Math.floor(Date.now() / 1000) },
              secretKey,
              { expiresIn: '1h' }
            );
            
            // 验证生成的token
            try {
              const decoded = jwt.verify(token, secretKey);
              console.log('Token验证成功:', decoded);
            } catch (err) {
              console.error('Token验证失败:', err.message);
            }
            
            console.log(token);
          ")
          
          echo "生成的JWT Token: ${JWT_TOKEN:0:20}..."
          echo "JWT Token 长度: ${#JWT_TOKEN}"
          
          # 调用API
          echo "调用API: ${NEXT_PUBLIC_URL}/api/cron/20-seconds-metrics-interval"
          
          # 构建完整的 URL
          FULL_URL="${NEXT_PUBLIC_URL}/api/cron/20-seconds-metrics-interval?token=${JWT_TOKEN}"
          echo "完整URL长度: ${#FULL_URL}"
          
          # 使用更安全的 curl 调用
          curl -X GET \
            --url "${FULL_URL}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions/1.0" \
            --fail-with-body \
            -w "\nHTTP Status: %{http_code}\nResponse Time: %{time_total}s\n" \
            -v

  run-interval:
    name: 3分钟交易执行
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '*/3 * * * *'
    
    steps:
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: 验证环境变量
        env:
          NEXT_PUBLIC_URL: ${{ secrets.NEXT_PUBLIC_URL }}
        run: |
          echo "检查必需的环境变量..."
          if [ -z "${{ secrets.CRON_SECRET_KEY }}" ]; then
            echo "❌ CRON_SECRET_KEY 未设置"
            exit 1
          fi
          if [ -z "${{ secrets.NEXT_PUBLIC_URL }}" ]; then
            echo "❌ NEXT_PUBLIC_URL 未设置"
            exit 1
          fi
          
          echo "✅ 环境变量检查通过"
          echo "🔍 调试信息:"
          echo "NEXT_PUBLIC_URL 长度: ${#NEXT_PUBLIC_URL}"
          echo "NEXT_PUBLIC_URL 内容: '${NEXT_PUBLIC_URL}'"
          
          # 验证 URL 格式
          if [[ ! "$NEXT_PUBLIC_URL" =~ ^https?:// ]]; then
            echo "❌ NEXT_PUBLIC_URL 格式错误，必须以 http:// 或 https:// 开头"
            exit 1
          fi
          
          echo "✅ URL 格式验证通过"
          
      - name: 生成JWT Token并执行交易逻辑
        env:
          CRON_SECRET_KEY: ${{ secrets.CRON_SECRET_KEY }}
          NEXT_PUBLIC_URL: ${{ secrets.NEXT_PUBLIC_URL }}
        run: |
          # 安装 jsonwebtoken
          npm install jsonwebtoken
          
          # 调试密钥信息
          echo "🔐 密钥调试信息:"
          echo "CRON_SECRET_KEY 长度: ${#CRON_SECRET_KEY}"
          echo "CRON_SECRET_KEY 前10字符: ${CRON_SECRET_KEY:0:10}..."
          
          # 生成JWT token
          JWT_TOKEN=$(node -e "
            const jwt = require('jsonwebtoken');
            const secretKey = process.env.CRON_SECRET_KEY;
            if (!secretKey) {
              console.error('CRON_SECRET_KEY is empty');
              process.exit(1);
            }
            
            console.log('密钥长度:', secretKey.length);
            console.log('密钥类型:', typeof secretKey);
            console.log('密钥前10字符:', secretKey.substring(0, 10) + '...');
            
            const token = jwt.sign(
              { sub: 'github-actions-cron', iat: Math.floor(Date.now() / 1000) },
              secretKey,
              { expiresIn: '1h' }
            );
            
            // 验证生成的token
            try {
              const decoded = jwt.verify(token, secretKey);
              console.log('Token验证成功:', decoded);
            } catch (err) {
              console.error('Token验证失败:', err.message);
            }
            
            console.log(token);
          ")
          
          echo "生成的JWT Token: ${JWT_TOKEN:0:20}..."
          echo "JWT Token 长度: ${#JWT_TOKEN}"
          
          # 调用API
          echo "调用API: ${NEXT_PUBLIC_URL}/api/cron/3-minutes-run-interval"
          
          # 构建完整的 URL
          FULL_URL="${NEXT_PUBLIC_URL}/api/cron/3-minutes-run-interval?token=${JWT_TOKEN}"
          echo "完整URL长度: ${#FULL_URL}"
          
          # 使用更安全的 curl 调用
          curl -X GET \
            --url "${FULL_URL}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions/1.0" \
            --fail-with-body \
            -w "\nHTTP Status: %{http_code}\nResponse Time: %{time_total}s\n" \
            -v